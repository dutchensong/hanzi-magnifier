<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>超大汉字放大器</title>

  <!-- Local-first WenKai (LXGWWenKai) with CDN fallback -->
  <link rel="preload" href="./fonts/LXGWWenKai-Regular.woff2" as="font" type="font/woff2" crossorigin>
  <style>
    @font-face {
      font-family: 'LXGWWenKai';
      src: url('./fonts/LXGWWenKai-Regular.woff2') format('woff2'),
           url('https://cdn.jsdelivr.net/gh/lxgw/LxgwWenKai@v1.330/WOFF2/LXGWWenKai-Regular.woff2') format('woff2');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
  </style>

  <!-- Other webfonts (for 宋/黑/隶 作为参考显示) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Noto+Serif+SC:wght@400;700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f7f7fb;--fg:#111;--muted:#666;--accent:#3b82f6;--card:#fff;--grid:#e5e7eb;--tian:#d1d5db;--mi:#d1d5db;
    }
    [data-theme="dark"]{--bg:#0b0c10;--fg:#f5f5f5;--muted:#b7b7b7;--accent:#60a5fa;--card:#121318;--grid:#2a2d34;--tian:#343843;--mi:#343843}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family: system-ui, -apple-system, "PingFang SC", "Noto Sans SC", "Microsoft YaHei", sans-serif;}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .toolbar{position:sticky;top:0;z-index:10;background:linear-gradient(var(--bg),var(--bg));backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--grid);}
    .toolbar .inner{display:flex;gap:12px;flex-wrap:wrap;align-items:center;padding:10px 4px}
    .card{background:var(--card);border:1px solid var(--grid);border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .control{display:flex;align-items:center;gap:8px;border:1px solid var(--grid);padding:8px 10px;border-radius:12px;background:transparent}
    input[type="text"]{font-size:18px;padding:10px 12px;border:1px solid var(--grid);border-radius:12px;min-width:220px;background:var(--card);color:var(--fg)}
    input[type="range"]{accent-color:var(--accent)}
    button{padding:10px 12px;border-radius:12px;border:1px solid var(--grid);background:var(--card);color:var(--fg);cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:transparent}
    button:active{transform:translateY(1px)}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));gap:12px}
    .tile{position:relative;aspect-ratio:1/1;border-radius:14px;border:1px solid var(--grid);overflow:hidden;background:var(--card);display:flex;align-items:center;justify-content:center}
    .tile .char{line-height:1;user-select:all;font-synthesis-weight:none} /* 禁止伪粗体 */
    .tile .pin{position:absolute;right:10px;top:10px;font-size:12px;color:var(--muted)}
    .tile .idx{position:absolute;left:10px;top:10px;font-size:12px;color:var(--muted)}
    .tile .gridlines{position:absolute;inset:0;pointer-events:none}
    .note{font-size:13px}
    .footer{color:var(--muted);text-align:center;padding:18px}
    .hidden{display:none}
    .outline{-webkit-text-stroke: 2px var(--fg);color:transparent}
    /* 田字格 */
    .tian::before, .tian::after, .tian .mid::before, .tian .mid::after{content:"";position:absolute;background:var(--tian)}
    .tian::before{width:1px;height:100%;left:50%;top:0;opacity:.6}
    .tian::after{height:1px;width:100%;top:50%;left:0;opacity:.6}
    .tian .mid::before{width:1px;height:100%;left:25%;top:0;opacity:.25}
    .tian .mid::after{width:1px;height:100%;left:75%;top:0;opacity:.25}
    /* 米字格 */
    .mi::before, .mi::after{content:"";position:absolute;background:var(--mi);opacity:.5}
    .mi::before{height:1px;width:141%;left:-20.5%;top:50%;transform:rotate(45deg)}
    .mi::after{height:1px;width:141%;left:-20.5%;top:50%;transform:rotate(-45deg)}
    .sq{outline: 1px dashed var(--grid)}
    .fullscreen{position:fixed;inset:0;padding:20px;background:var(--bg);z-index:999}
  </style>
</head>
<body>
  <div class="toolbar">
    <div class="container inner">
      <input id="text" type="text" inputmode="text" placeholder="输入要放大的字或词语（支持多个字）"/>
      <label class="control">字号 <input id="size" type="range" min="100" max="200" step="5" value="150"> <span id="sizeVal" class="muted">150px</span></label>
      <label class="control">字体
        <select id="font">
          <option value="kaiti" selected>楷体</option>
          <option value="song">宋体</option>
          <option value="hei">黑体</option>
          <option value="li">隶书</option>
        </select>
      </label>
      <label class="control"><input type="checkbox" id="outline"> 描边</label>
      <label class="control">格子
        <select id="gridtype">
          <option value="tian" selected>田字格</option>
          <option value="mi">米字格</option>
          <option value="square">方格</option>
          <option value="none">无</option>
        </select>
      </label>
      <label class="control"><input type="checkbox" id="remember" checked> 记住偏好</label>
      <button id="btnReset" title="清除保存并恢复默认">重置</button>
      <button id="btnFS">全屏</button>
      <button id="btnTheme">深浅</button>
      <button id="btnCopy">复制文字</button>
      <button id="btnClear">清空</button>
      <span class="muted note">小技巧：把本页面“添加到主屏幕”，像App一样打开。</span>
    </div>
  </div>

  <div class="container">
    <div id="grid" class="grid"></div>

    <div class="footer">为低年级孩子写日记查字而做。支持触控放大（双指缩放）、单击某个字可独立全屏显示。</div>
  </div>

  <template id="tileTpl">
    <div class="tile card">
      <span class="idx"></span>
      <span class="pin"></span>
      <div class="gridlines"></div>
      <div class="char" aria-label="char"></div>
    </div>
  </template>

  <div id="solo" class="hidden"></div>

<script>
(function(){
  const $ = (s,root=document)=>root.querySelector(s);
  const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
  const text = $('#text');
  const size = $('#size');
  const sizeVal = $('#sizeVal');
  const outline = $('#outline');
  const gridtype = $('#gridtype');
  const grid = $('#grid');
  const btnFS = $('#btnFS');
  const btnTheme = $('#btnTheme');
  const btnCopy = $('#btnCopy');
  const btnClear = $('#btnClear');
  const solo = $('#solo');
  const fontSel = $('#font');
  const remember = $('#remember');
  const btnReset = $('#btnReset');

  const state = {
    text: localStorage.getItem('bch_text') || '作业 日记 汉字',
    size: +localStorage.getItem('bch_size') || 150,
    outline: localStorage.getItem('bch_outline') === '1' ? true : false,
    grid: localStorage.getItem('bch_grid') || 'tian',
    theme: localStorage.getItem('bch_theme') || 'light',
    font: localStorage.getItem('bch_font') || 'kaiti',
    remember: (localStorage.getItem('bch_remember') !== '0')
  };
  // 保护旧缓存：若旧字号超范围，回到150
  state.size = (state.size<100 || state.size>200) ? 150 : state.size;

  function applyTheme(){
    document.documentElement.setAttribute('data-theme', state.theme==='dark'?'dark':'light');
  }

  function fontStack(k){
    switch(k){
      case 'kaiti': return 'LXGWWenKai, "Kaiti SC","STKaiti","KaiTi","Kaiti","DFKai-SB","BiauKai","AR PL UKai CN","AR PL UKai TW","TW-Kai", serif';
      case 'song': return '"Noto Serif SC","Songti SC","SimSun","Noto Serif CJK SC","Source Han Serif SC", serif';
      case 'hei':  return '"Noto Sans SC","PingFang SC","Microsoft YaHei","Noto Sans CJK SC","Source Han Sans SC","Hiragino Sans GB","Arial", sans-serif';
      case 'li':   return '"Ma Shan Zheng","LiSu","STLiti","KaiTi","Kaiti", serif';
      default:     return 'LXGWWenKai, "Kaiti SC","KaiTi", serif';
    }
  }
  const DEFAULTS = { size:150, outline:false, grid:'tian', theme:'light', font:'kaiti' };

  function render(){
    sizeVal.textContent = state.size + 'px';
    grid.innerHTML = '';
    const chars = [...(state.text.replace(/\s+/g,'').trim())];
    if(chars.length===0){ grid.innerHTML = '<div class="muted" style="padding:24px">在上方输入要放大的字～</div>'; return; }
    chars.forEach((ch, i)=>{
      const tpl = document.importNode($('#tileTpl').content, true);
      const tile = tpl.querySelector('.tile');
      const chEl = tpl.querySelector('.char');
      const pin = tpl.querySelector('.pin');
      const idx = tpl.querySelector('.idx');
      const lines = tpl.querySelector('.gridlines');

      chEl.textContent = ch;
      chEl.style.fontSize = state.size + 'px';
      chEl.style.fontFamily = fontStack(state.font);
      chEl.classList.toggle('outline', !!state.outline);

      idx.textContent = i+1;
      pin.textContent = ch.charCodeAt(0).toString(16).toUpperCase();

      lines.className = 'gridlines';
      if(state.grid==='tian'){
        lines.classList.add('tian');
        const mid = document.createElement('div');
        mid.className = 'mid';
        lines.appendChild(mid);
      }else if(state.grid==='mi'){
        lines.classList.add('mi');
      }else if(state.grid==='square'){
        tile.classList.add('sq');
      }

      tile.addEventListener('click',()=>openSolo(ch));
      grid.appendChild(tpl);
    });
  }

  function openSolo(ch){
    solo.className = 'fullscreen';
    solo.innerHTML = '';
    const wrap = document.createElement('div');
    wrap.style.width='100%';wrap.style.height='100%';wrap.style.display='flex';wrap.style.alignItems='center';wrap.style.justifyContent='center';wrap.style.position='relative';
    const lines = document.createElement('div');
    lines.className = 'gridlines';
    if(state.grid==='tian'){
      lines.classList.add('tian'); const mid=document.createElement('div');mid.className='mid';lines.appendChild(mid);
    }else if(state.grid==='mi'){
      lines.classList.add('mi');
    }else if(state.grid==='square'){
      lines.classList.add('sq');
    }
    const c = document.createElement('div');
    c.textContent = ch; c.className='char';
    const base = Math.min(window.innerWidth, window.innerHeight) * 0.75;
    c.style.fontSize = Math.max(base, state.size) + 'px';
    c.style.fontFamily = fontStack(state.font);
    c.classList.toggle('outline', !!state.outline);

    const back = document.createElement('button');
    back.textContent = '返回';
    back.style.position='absolute';back.style.left='20px';back.style.top='20px';
    back.style.padding='12px 14px';back.style.borderRadius='12px';
    back.style.border='1px solid var(--grid)';back.style.background='var(--card)';
    back.onclick = ()=>{ solo.className='hidden'; solo.innerHTML=''; };

    wrap.appendChild(lines);wrap.appendChild(c);wrap.appendChild(back);
    solo.appendChild(wrap);
  }

  // 初始化UI
  text.value = state.text; size.value = state.size; sizeVal.textContent = state.size+'px';
  outline.checked = state.outline; gridtype.value = state.grid; if(fontSel) fontSel.value = state.font; if(remember) remember.checked = state.remember; applyTheme();
  render();

  // 事件绑定
  text.addEventListener('input',()=>{ state.text=text.value; if(state.remember) localStorage.setItem('bch_text',state.text); render(); });
  size.addEventListener('input',()=>{ state.size=+size.value; if(state.remember) localStorage.setItem('bch_size',state.size); render(); });
  outline.addEventListener('change',()=>{ state.outline=outline.checked; if(state.remember) localStorage.setItem('bch_outline',state.outline?'1':'0'); render(); });
  gridtype.addEventListener('change',()=>{ state.grid=gridtype.value; if(state.remember) localStorage.setItem('bch_grid',state.grid); render(); });
  if(fontSel){ fontSel.addEventListener('change',()=>{ state.font = fontSel.value; if(state.remember) localStorage.setItem('bch_font', state.font); render(); }); }
  if(remember){ remember.addEventListener('change',()=>{ state.remember = remember.checked; localStorage.setItem('bch_remember', state.remember ? '1':'0'); }); }

  btnFS.addEventListener('click',()=>{
    if(document.fullscreenElement){document.exitFullscreen();}
    else{document.documentElement.requestFullscreen().catch(()=>openSolo((state.text||'字')[0]||'字'));}
  });
  btnTheme.addEventListener('click',()=>{
    state.theme = state.theme==='dark'?'light':'dark';
    if(state.remember) localStorage.setItem('bch_theme',state.theme); applyTheme();
  });
  btnCopy.addEventListener('click',async()=>{
    try{await navigator.clipboard.writeText(state.text); btnCopy.textContent='已复制'; setTimeout(()=>btnCopy.textContent='复制文字',1000);}catch(e){alert('复制失败：'+e.message)}
  });
  btnClear.addEventListener('click',()=>{ text.value=''; text.dispatchEvent(new Event('input')); });

  if(btnReset){
    btnReset.addEventListener('click',()=>{
      ['bch_text','bch_size','bch_outline','bch_grid','bch_theme','bch_font'].forEach(k=>localStorage.removeItem(k));
      state.size = DEFAULTS.size; state.outline = DEFAULTS.outline; state.grid = DEFAULTS.grid; state.theme = DEFAULTS.theme; state.font = DEFAULTS.font;
      size.value = String(DEFAULTS.size); outline.checked = DEFAULTS.outline; gridtype.value = DEFAULTS.grid; if(fontSel) fontSel.value = DEFAULTS.font; text.value='';
      applyTheme(); render();
    });
  }

  // iPad优化：防止双击缩放
  let lastTouch=0; window.addEventListener('touchend',e=>{const now=Date.now(); if(now-lastTouch<300){e.preventDefault();} lastTouch=now;},{passive:false});
})();
</script>
</body>
</html>
